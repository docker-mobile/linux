name: Build Arch-style x86_64 kernel (bin)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - uses: actions/checkout@v4

      - name: Init pacman
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm

      - name: Install deps
        run: |
          pacman -S --noconfirm \
            base-devel git bc libelf pahole cpio \
            kmod inetutils python mkinitcpio

      - name: Configure kernel
        run: |
          make mrproper
          cp config .config
          make olddefconfig

      - name: Build kernel
        run: |
          make -j$(nproc)
          make modules_install INSTALL_MOD_PATH=modules

      - name: Get kernel version
        run: |
          echo "KVER=$(make kernelrelease)" >> $GITHUB_ENV

      - name: Create Arch-style layout
        run: |
          mkdir -p pkg/usr/lib/modules/$KVER
          cp arch/x86/boot/bzImage pkg/usr/lib/modules/$KVER/vmlinuz
          cp -r modules/lib/modules/$KVER/* pkg/usr/lib/modules/$KVER/

          echo "linux-docker-mobile-git-bin" \
            > pkg/usr/lib/modules/$KVER/pkgbase

      - name: Add mkinitcpio preset
        run: |
          mkdir -p pkg/etc/mkinitcpio.d
          cat > pkg/etc/mkinitcpio.d/linux-docker-mobile-git-bin.preset <<EOF
          ALL_config="/etc/mkinitcpio.conf"
          ALL_kver="$KVER"
          PRESETS=('default')

          default_image="/boot/initramfs-linux-docker-mobile-git-bin.img"
          default_options=""
          EOF

      - name: Add pacman hooks
        run: |
          mkdir -p pkg/usr/share/libalpm/hooks

          cat > pkg/usr/share/libalpm/hooks/90-linux-docker-mobile-install.hook <<EOF
          [Trigger]
          Type = Package
          Operation = Install
          Operation = Upgrade
          Target = linux-docker-mobile-git-bin

          [Action]
          Description = Updating initramfs...
          When = PostTransaction
          Exec = /usr/bin/mkinitcpio -P
          EOF

          cat > pkg/usr/share/libalpm/hooks/60-linux-docker-mobile-remove.hook <<EOF
          [Trigger]
          Type = Package
          Operation = Remove
          Target = linux-docker-mobile-git-bin

          [Action]
          Description = Removing initramfs...
          When = PreTransaction
          Exec = /usr/bin/rm -f /boot/initramfs-linux-docker-mobile-git-bin.img
          EOF

      - name: Package binaries
        run: |
          tar -C pkg -czf linux-docker-mobile-git-bin.tar.gz .

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: latest
          files: linux-docker-mobile-git-bin.tar.gz
